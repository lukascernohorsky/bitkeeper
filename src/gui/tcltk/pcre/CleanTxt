#!/usr/bin/env tclsh
# Tcl rewrite of PCRE CleanTxt: filter nroff -man output for online readability.
# Mirrors the original Perl behavior: strips ESC color sequences and backspaces,
# keeps only the first header, collapses excessive blanks, and trims page-footers.

set blankcount 0
set lastwascut 0
set firstheader 1
set lastprinted ""

# Read stdin line-by-line
while {[gets stdin line] >= 0} {
    # Remove screen controls and backspaces
    regsub -all {\x1b\[[0-9]+m} $line {} line
    regsub -all {.\x08} $line {} line

    # Handle header lines (keep the first only)
    if {[regexp {^PCRE(\w*)\(([13])\)\s+PCRE\1\(\2\)$} $line]} {
        if {$firstheader} {
            set firstheader 0
            puts $line
            set lastprinted $line
            set lastwascut 0
        }
        # Drop the blank line following the header if present
        gets stdin _
        continue
    }

    # Count runs of empty lines
    if {[regexp {^\s*$} $line]} {
        incr blankcount
        set lastwascut 0
        continue
    }

    # Restore a blank if a cut chunk changed indentation
    if {$lastwascut && $blankcount < 1 && $lastprinted ne ""} {
        regexp {^(\s*)} $lastprinted -> a
        regexp {^(\s*)} $line -> b
        if {$a ne $b} {incr blankcount}
    }

    if {$blankcount >= 3} {
        # Look ahead three lines, stripping control sequences
        set next {}
        for {set i 0} {$i < 3} {incr i} {
            if {[gets stdin nxt] < 0} {set nxt ""}
            regsub -all {\x1b\[[0-9]+m} $nxt {} nxt
            regsub -all {.\x08} $nxt {} nxt
            lappend next $nxt
        }

        # Cut chunks of <3 blanks><non-blank><3 blanks>
        if {[lindex $next 0] eq "" && [lindex $next 1] eq "" && [lindex $next 2] eq ""} {
            incr blankcount -3
            set lastwascut 1
            continue
        } else {
            for {set i 0} {$i < $blankcount} {incr i} {puts ""}
            puts $line
            for {set i 0} {$i < 3} {incr i} {
                set nxt [lindex $next $i]
                regsub -all {.\x08} $nxt {} nxt
                puts $nxt
                set lastprinted $line
            }
            set lastwascut 0
            set blankcount 0
            continue
        }
    }

    # Default path: output blanks then the current line, forcing double blanks
    if {[regexp {^\S} $line] && ![regexp {^(Last updated|Copyright)} $line] && $lastprinted ne ""} {
        set blankcount 2
    }
    for {set i 0} {$i < $blankcount} {incr i} {puts ""}
    puts $line
    set lastprinted $line
    set lastwascut 0
    set blankcount 0
}
