#!/usr/bin/env tclsh
# Convert PCRE man pages to HTML without requiring the original Perl helper.

package require Tcl 8.6

proc htmlEscape {text} {
    set text [string map {& &amp; < &lt; > &gt;} $text]
    return $text
}

set toc 0
set title "man page"
set rest {}
foreach arg $argv {
    if {$arg eq "-toc"} {
        set toc 1
        continue
    }
    lappend rest $arg
}
if {[llength $rest] > 0} {
    set title [lindex $rest 0]
}
set input [read stdin]
set rendered ""
if {[catch {exec groff -mandoc -Thtml << $input} rendered]} {
    set rendered "<pre>[htmlEscape $input]</pre>"
}
puts "<html>"
puts "<head><title>$title man page</title></head>"
puts "<body>"
puts "<h1>$title man page</h1>"
if {$toc} {
    puts "<!-- Table of contents omitted in Tcl rewrite; rely on browser search. -->"
}
puts $rendered
puts "</body></html>"
