#!/usr/bin/env tclsh
# Remove trailing whitespace from the lines of each file provided on the
# command line. Mirrors the original Perl helper's behavior by only
# trimming whitespace that precedes an existing newline and leaving
# non-newline-terminated final lines untouched.

proc detrail {file} {
    set fh [open $file r]
    fconfigure $fh -translation binary -encoding binary
    set data [read $fh]
    close $fh

    set hasTrailingNL [string match *\n $data]
    set rawLines [split $data "\n"]
    if {$hasTrailingNL} {
        # Drop the empty element produced by split when the file ends in a newline.
        set rawLines [lrange $rawLines 0 end-1]
    }

    set changed 0
    set output {}
    set count [llength $rawLines]
    for {set i 0} {$i < $count} {incr i} {
        set line [lindex $rawLines $i]
        set needsNL 1
        if {$i == $count - 1 && !$hasTrailingNL} {
            set needsNL 0
        }
        if {$needsNL && [regexp {\s+$} $line]} {
            regsub {\s+$} $line "" line
            set changed 1
        }
        if {$needsNL} {
            append line "\n"
        }
        lappend output $line
    }

    if {$changed} {
        set out [open $file w]
        fconfigure $out -translation binary -encoding binary
        foreach line $output {
            puts -nonewline $out $line
        }
        close $out
    }
}

set status 0
foreach file $argv {
    if {[catch {detrail $file} err]} {
        puts stderr "Detrail: $file: $err"
        set status 1
    }
}
exit $status
