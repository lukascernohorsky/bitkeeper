#!/usr/bin/env tclsh
# Convert K&R style C function definitions to ANSI form (Tcl port).
# This is a best-effort translation that keeps parameter ordering and types
# while avoiding the original Perl dependency.

proc parseDeclLine {line paramTypes paramOrderVar} {
    upvar 1 $paramTypes types
    upvar 1 $paramOrderVar order
    set trimmed [string trim $line " \t;" ]
    if {$trimmed eq ""} return
    # Split declarations separated by commas while preserving common type
    set commonType ""
    if {[regexp {^(.*?\S)\s+([A-Za-z_][A-Za-z0-9_]*)\s*(,.*)?$} $trimmed -> type name rest]} {
        set commonType $type
        set names [list $name]
        if {$rest ne ""} {
            foreach n [split [string trim [string trimleft $rest ,]] ,] {
                lappend names [string trim $n]
            }
        }
    } else {
        return
    }
    foreach n $names {
        set types($n) [string trim "$commonType"]
        if {[lsearch -exact $order $n] < 0} {
            lappend order $n
        }
    }
}

proc convertKRtoANSI {text} {
    set out {}
    set lines [split $text "\n"]
    set count [llength $lines]
    set i 0
    while {$i < $count} {
        set line [lindex $lines $i]
        if {[regexp {^([A-Za-z_].*?)\s*\(([^()]*)\)\s*$} $line -> prefix params]} {
            set j [expr {$i + 1}]
            set decls {}
            set brace -1
            while {$j < $count} {
                set next [lindex $lines $j]
                if {[regexp {^\s*\{\s*$} $next]} {
                    set brace $j
                    break
                }
                lappend decls $next
                incr j
            }
            if {$brace > 0 && [llength $decls] > 0} {
                array unset paramTypes
                set order {}
                foreach d $decls { parseDeclLine $d paramTypes order }
                set args {}
                foreach p [split $params ,] {
                    set name [string trim $p]
                    if {$name eq ""} continue
                    set type [expr {[info exists paramTypes($name)] ? $paramTypes($name) : ""}]
                    set decl [string trim "$type $name"]
                    lappend args "    $decl"
                }
                lappend out "$prefix("
                if {[llength $args]} {
                    lappend out [join $args ",\n"]
                }
                lappend out ")"
                lappend out "{"
                set i $brace
                incr i
                continue
            }
        }
        lappend out $line
        incr i
    }
    return [join $out "\n"]
}

set data ""
if {[llength $argv] == 0} {
    set data [read stdin]
    puts [convertKRtoANSI $data]
    exit 0
}

foreach file $argv {
    set in [open $file r]
    set text [read $in]
    close $in
    set converted [convertKRtoANSI $text]
    set out [open $file w]
    puts -nonewline $out $converted
    close $out
}
