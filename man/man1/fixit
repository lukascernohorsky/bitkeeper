#!/usr/bin/env tclsh
# Adapted from the original Perl helper to normalize .TH version and
# rewrite .SA lines while preserving passthrough behavior for quoted
# entries.

set sa {}
set rest {}
set sawSa 0

# Stream input until the first .SA directive or EOF
while {[gets stdin line] >= 0} {
    if {[regexp {^\.TH\s} $line]} {
        regsub { 1 } $line { "\\*[BKVER]" } line
    }
    if {![regexp {^\.SA} $line]} {
        puts $line
        continue
    }
    set sawSa 1
    break
}

if {!$sawSa} {
    exit 0
}

lappend sa $line
while {[gets stdin line] >= 0} {
    if {[regexp {^\.SA} $line]} {
        lappend sa $line
    } else {
        lappend rest $line
    }
}

# Trim trailing ".SA |" entries
while {[llength $sa] > 0 && [lindex $sa end] eq ".SA |"} {
    set sa [lrange $sa 0 end-1]
}

foreach entry $sa {
    if {[string first {"} $entry] != -1} {
        puts stderr "Passing verbatum: $entry"
        puts $entry
        continue
    }
    set tokens [split $entry]
    if {[llength $tokens] >= 2} {
        puts ".SA [lindex $tokens 1]"
    } else {
        puts $entry
    }
}

foreach entry $rest {
    puts $entry
}
